<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Screen Timer</title>

<style>
:root{
  --bg:#000000;
  --card:#0a0a0a;
  --line: rgba(255,255,255,0.14);
  --text:#ffffff;
  --muted: rgba(255,255,255,0.68);
  --btnbg: rgba(255,255,255,0.06);
  --btnhover: rgba(255,255,255,0.10);
  --danger:#ff5c7a;

  --radius:16px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}

/* Two flat themes only */

body.theme-dark{
  --bg:#000000;
  --card:#0a0a0a;
  --line: rgba(255,255,255,0.14);
  --text:#ffffff;
  --muted: rgba(255,255,255,0.68);
  --btnbg: rgba(255,255,255,0.06);
  --btnhover: rgba(255,255,255,0.10);
}

body.theme-white{
  --bg:#f7f7f5;
  --card:#ffffff;
  --line: rgba(10,10,10,0.12);
  --text:#0a0a0a;
  --muted: rgba(10,10,10,0.62);
  --btnbg: rgba(10,10,10,0.05);
  --btnhover: rgba(10,10,10,0.09);
}

*{box-sizing:border-box;}
html,body{height:100%;margin:0;}

body{
  font-family: var(--sans);
  background: var(--bg);
  color: var(--text);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
}

.card{
  width:min(640px,100%);
  background: var(--card);
  border:1px solid var(--line);
  border-radius: var(--radius);
  padding:18px;
}

.top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  flex-wrap: wrap;
}

.status{
  font-size: 12px;
  color: var(--muted);
  font-weight: 700;
}

.time{
  font-family: var(--mono);
  font-size: clamp(52px, 12vw, 94px);
  letter-spacing: 1px;
  margin: 18px 0 16px 0;
  text-align:left;
}

.controls{
  display:flex;
  gap:10px;
  flex-wrap: wrap;
  align-items:center;
}

.field{
  display:flex;
  align-items:center;
  gap:8px;
  border:1px solid var(--line);
  border-radius: 12px;
  padding:8px 10px;
  background: transparent;
}

label{
  font-size:12px;
  color: var(--muted);
  font-weight: 700;
}

input, select{
  border:0;
  outline:none;
  background: transparent;
  color: var(--text);
  font-weight: 700;
  font-family: var(--mono);
}

input[type="number"]{width:80px;}

button{
  border:1px solid var(--line);
  background: var(--btnbg);
  color: var(--text);
  padding:10px 12px;
  border-radius: 12px;
  cursor:pointer;
  font-weight: 800;
}

button:hover{background: var(--btnhover);}

button.danger{
  color: var(--danger);
  border-color: rgba(255,92,122,0.45);
}

.small{
  margin: 10px 0 0 0;
  font-size: 12px;
  color: var(--muted);
  line-height: 1.45;
}

.notifState{
  margin: 8px 0 0 0;
  font-size: 12px;
  color: var(--muted);
  font-family: var(--mono);
}

/* Pop-up (stays until dismissed) */

.overlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  background: rgba(0,0,0,0.55);
}

body.theme-white .overlay{
  background: rgba(10,10,10,0.35);
}

.overlay.show{display:flex;}

.modal{
  width:min(520px,100%);
  background: var(--card);
  border:1px solid var(--line);
  border-radius: 16px;
  padding:18px;
  text-align:center;
}

.modal h2{
  margin: 0 0 10px 0;
  font-weight: 900;
  font-size: 18px;
}

.modal p{
  margin: 0 0 16px 0;
  color: var(--muted);
  line-height: 1.55;
  font-size: 14px;
}
</style>
</head>

<body class="theme-dark">

<main class="card">
  <div class="top">
    <div class="status" id="stateText">Stopped</div>

    <div class="controls">
      <div class="field">
        <label for="minutesInput">Minutes</label>
        <input id="minutesInput" type="number" min="1" max="600" value="20" />
      </div>

      <div class="field">
        <label for="themeSelect">Theme</label>
        <select id="themeSelect">
          <option value="theme-dark" selected>Dark</option>
          <option value="theme-white">White</option>
        </select>
      </div>
    </div>
  </div>

  <div class="time" id="timeDisplay">20:00</div>

  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="pauseBtn">Pause</button>
    <button class="danger" id="resetBtn">Reset</button>
    <button id="notifBtn">Enable notifications</button>
  </div>

  <p class="notifState" id="notifState">Notifications: unknown</p>
  <p class="small">Timer continues while you switch tabs (as long as your browser stays open).</p>
</main>

<div class="overlay" id="overlay">
  <div class="modal" role="dialog" aria-modal="true">
    <h2>Take a break</h2>
    <p>Timer finished.</p>
    <div class="controls" style="justify-content:center;">
      <button id="dismissBtn">Dismiss</button>
      <button id="restartBtn">Restart</button>
    </div>
  </div>
</div>

<script>
(function(){
  const display = document.getElementById("timeDisplay");
  const minutesInput = document.getElementById("minutesInput");
  const themeSelect = document.getElementById("themeSelect");
  const stateText = document.getElementById("stateText");
  const notifState = document.getElementById("notifState");

  const overlay = document.getElementById("overlay");
  const dismissBtn = document.getElementById("dismissBtn");
  const restartBtn = document.getElementById("restartBtn");

  let duration = 20 * 60 * 1000;
  let remaining = duration;
  let running = false;
  let lastTick = performance.now();

  function format(ms){
    const total = Math.ceil(ms / 1000);
    const m = Math.floor(total / 60);
    const s = total % 60;
    return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
  }

  function setNotifStateText(){
    if (!("Notification" in window)) {
      notifState.textContent = "Notifications: not supported";
      return;
    }
    notifState.textContent = "Notifications: " + Notification.permission;
  }

  function tick(){
    const now = performance.now();
    const dt = now - lastTick;
    lastTick = now;

    if (running){
      remaining -= dt;
      if (remaining <= 0){
        finish();
        return;
      }
    }

    display.textContent = format(remaining);
    requestAnimationFrame(tick);
  }

  function start(){
    overlay.classList.remove("show");
    if (remaining <= 0) remaining = duration;
    running = true;
    stateText.textContent = "Running";
    lastTick = performance.now();
  }

  function pause(){
    running = false;
    stateText.textContent = "Paused";
  }

  function reset(){
    running = false;
    remaining = duration;
    display.textContent = format(remaining);
    stateText.textContent = "Stopped";
    overlay.classList.remove("show");
  }

  function finish(){
    running = false;
    remaining = 0;
    display.textContent = "00:00";
    stateText.textContent = "Finished";
    notifyPersistent();
    playLongNonMusicalSound();
    overlay.classList.add("show");
  }

  async function requestNotif(){
    if (!("Notification" in window)) {
      alert("Notifications are not supported in this browser.");
      return;
    }

    try{
      const perm = await Notification.requestPermission();
      setNotifStateText();

      if (perm === "granted") {
        // Test notification so you can see it immediately
        new Notification("Notifications enabled", {
          body: "You will get an alert when the timer ends.",
          requireInteraction: true
        });
      } else if (perm === "denied") {
        alert("Notifications are blocked. Allow them in your browser site settings and refresh.");
      }
    } catch(e){
      alert("Could not request notification permission. Check browser and system notification settings.");
    }
  }

  function notifyPersistent(){
    if (!("Notification" in window)) return;
    if (Notification.permission !== "granted") return;

    // requireInteraction keeps it on screen on supported browsers (Chrome/Edge desktop).
    // Some mobile browsers ignore it; that is an OS/browser limitation.
    new Notification("Take a break", {
      body: "Timer finished.",
      requireInteraction: true
    });
  }

  function playLongNonMusicalSound(){
    // Longer white-noise burst, still non-musical (no tone, no melody).
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();

      const seconds = 2.5;
      const bufferSize = Math.floor(ctx.sampleRate * seconds);
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);

      for (let i = 0; i < data.length; i++){
        data[i] = (Math.random() * 2 - 1) * 0.12;
      }

      const src = ctx.createBufferSource();
      src.buffer = buffer;

      // Gentle fade in/out so it is not harsh
      const gain = ctx.createGain();
      const now = ctx.currentTime;
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.9, now + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + seconds);

      src.connect(gain);
      gain.connect(ctx.destination);

      src.start();
      src.stop(now + seconds);

      setTimeout(() => ctx.close(), (seconds * 1000) + 600);
    } catch(e){}
  }

  minutesInput.addEventListener("change", () => {
    const m = Math.max(1, Number(minutesInput.value || 20));
    minutesInput.value = String(m);
    duration = m * 60 * 1000;
    remaining = duration;
    display.textContent = format(remaining);
    if (!running) stateText.textContent = "Stopped";
  });

  themeSelect.addEventListener("change", () => {
    document.body.className = themeSelect.value;
  });

  document.getElementById("startBtn").addEventListener("click", start);
  document.getElementById("pauseBtn").addEventListener("click", pause);
  document.getElementById("resetBtn").addEventListener("click", reset);
  document.getElementById("notifBtn").addEventListener("click", requestNotif);

  dismissBtn.addEventListener("click", () => overlay.classList.remove("show"));
  restartBtn.addEventListener("click", () => {
    reset();
    start();
  });

  display.textContent = format(remaining);
  setNotifStateText();
  requestAnimationFrame(tick);
})();
</script>

</body>
</html>
